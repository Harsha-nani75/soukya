<!-- Loading Indicator -->
<div class="container-fluid mt-4" *ngIf="loading">
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-lg">
        <div class="card-body text-center py-5">
          <div class="spinner-border text-primary mb-4" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h3 class="text-primary mb-3 fw-bold">Loading Patient Data...</h3>
          <p class="text-muted fs-5">Please wait while we fetch the patient information</p>
          <div class="progress mt-4" style="height: 8px; border-radius: 10px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                 role="progressbar" 
                 style="width: 100%" 
                 aria-valuenow="100" 
                 aria-valuemin="0" 
                 aria-valuemax="100"></div>
          </div>
          
          <!-- Debug Info (only in development) -->
          <div class="mt-4 p-3 bg-light rounded-3 border">
            <small class="text-muted">
              <strong>Debug Info:</strong><br>
              Loading: {{ loading }}<br>
              Patient: {{ patient ? 'Yes' : 'No' }}<br>
              Error: {{ error || 'None' }}
            </small>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-secondary me-2" (click)="checkState()">
                <i class="fa fa-bug me-1"></i>Check State
              </button>
              <button class="btn btn-sm btn-outline-warning" (click)="forceRefresh()">
                <i class="fa fa-sync-alt me-1"></i>Force Refresh
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Message -->
<div class="container-fluid mt-4" *ngIf="!loading && error">
  <div class="row">
    <div class="col-12">
      <div class="card border-danger shadow-lg">
        <div class="card-body text-center py-5">
          <i class="fa fa-exclamation-triangle text-danger mb-4" style="font-size: 5rem;"></i>
          <h3 class="text-danger mb-3 fw-bold">Error Loading Patient Data</h3>
          <p class="text-muted mb-4 fs-5">{{ error }}</p>
          <div class="d-flex justify-content-center gap-3 flex-wrap">
            <button class="btn btn-primary btn-lg" (click)="fetchPatient(patientId!)">
              <i class="fa fa-refresh me-2"></i>Retry
            </button>
            <button class="btn btn-outline-secondary btn-lg" (click)="goBack()">
              <i class="fa fa-arrow-left me-2"></i>Back to Patient List
            </button>
            <button class="btn btn-outline-warning btn-lg" (click)="forceRefresh()">
              <i class="fa fa-sync-alt me-2"></i>Force Refresh
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Patient Data -->
<div class="container-fluid mt-4" *ngIf="!loading && patient">

  <!-- Success Message (Temporary) -->
  <div class="row mb-3" *ngIf="patient">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <i class="fa fa-check-circle me-2"></i>
        <strong>Patient data loaded successfully!</strong> 
        Viewing details for {{ patient.name }} {{ patient.lname }} (ID: {{ patient.patient_id || patient.id }})
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Patient Header with Back Button -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div class="d-flex align-items-center">
          <button class="btn btn-outline-secondary me-3" (click)="goBack()">
            <i class="fa fa-arrow-left me-2"></i>
            <span class="d-none d-sm-inline">Back to Patient List</span>
            <span class="d-inline d-sm-none">Back</span>
          </button>
          <div>
            <h2 class="mb-1 fw-bold">
              <i class="fa fa-user-circle me-2 text-primary"></i>
              {{ patient.name }} {{ patient.lname }}
            </h2>
            <p class="text-muted mb-0">
              <i class="fa fa-id-card me-1"></i>
              Patient ID: {{ patient.patient_id || patient.id }}
            </p>
          </div>
        </div>
        <div class="d-flex gap-2">
          <!-- <button class="btn btn-outline-info btn-sm" (click)="checkState()">
            <i class="fa fa-info-circle me-1"></i>Debug
          </button> -->
          <div class="dropdown">
            <button class="btn btn-primary btn-sm dropdown-toggle" (click)="openDropdown()" type="button">
              <i class="fa fa-edit me-2"></i>Edit Options
            </button>
            <div class="dropdown-menu" [class.show]="showDropdown" style="display: block;">
              <button class="dropdown-item" (click)="editPersonalDetails()">
                <i class="fa fa-user me-2"></i>Edit Personal Details
              </button>
              <button class="dropdown-item" (click)="editCaretakers()">
                <i class="fa fa-users me-2"></i>Edit Caretakers
              </button>
              <button class="dropdown-item" (click)="editHabits()">
                <i class="fa fa-smoking me-2"></i>Edit Habits
              </button>
              <button class="dropdown-item" (click)="editInsurance()">
                <i class="fa fa-shield me-2"></i>Edit Insurance
              </button>
              <button class="dropdown-item" (click)="editQuestions()">
                <i class="fa fa-question-circle me-2"></i>Edit Health Questions
              </button>
              <button class="dropdown-item" (click)="editDiseases()">
                <i class="fa fa-heartbeat me-2"></i>Edit Diseases
              </button>
              <button class="dropdown-item" (click)="editPhoto()">
                <i class="fa fa-camera me-2"></i>Edit Photo
              </button>
              <!-- <button class="dropdown-item" (click)="editPolicyFiles()">
                <i class="fa fa-file-alt me-2"></i>Edit Policy Files
              </button>
                              <button class="dropdown-item" (click)="editProofFiles()">
                  <i class="fa fa-file-alt me-2"></i>Edit Proof Files
                </button> -->
                

              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug File Structure (Development Only) -->
  <!-- <div class="row mb-3" *ngIf="patient?.files">
    <div class="col-12">
      <div class="alert alert-info">
        <h6 class="mb-2"><i class="fa fa-info-circle me-2"></i>File Structure Debug Info</h6>
        <div class="row">
          <div class="col-md-4">
            <strong>Photo:</strong> 
            <small class="text-muted d-block">{{ patient.files.photo || 'Not uploaded' }}</small>
          </div>
          <div class="col-md-4">
            <strong>Proof Files:</strong> 
            <small class="text-muted d-block">{{ patient.files.proof?.length || 0 }} files</small>
            <small class="text-muted d-block" *ngFor="let file of patient.files.proof">{{ file }}</small>
          </div>
          <div class="col-md-4">
            <strong>Policy Files:</strong> 
            <small class="text-muted d-block">{{ patient.files.policy?.length || 0 }} files</small>
            <small class="text-muted d-block" *ngFor="let file of patient.files.policy">{{ file }}</small>
          </div>
        </div>
      </div>
    </div>
  </div> -->

  <div class="row g-4">

    <!-- Card 1: Basic Info -->
    <div class="col-lg-4 col-md-6">
      <div class="card shadow-lg h-100 border-0">
        <div class="card-header bg-primary text-white py-3">
          <h5 class="mb-0 fw-bold">
            <i class="fa fa-user me-2"></i>Basic Information
          </h5>
        </div>
        <div class="card-body text-center p-4">
          <div class="position-relative mb-4">
            <img [src]="patient.photo || 'assets/image.png'" 
                 class="rounded-circle shadow" 
                 style="width:140px; height:140px; object-fit:cover; border: 4px solid #fff;">
            <div class="position-absolute bottom-0 end-0 bg-success text-white rounded-circle p-2" 
                 style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <i class="fa fa-check"></i>
            </div>
          </div>
          <div class="text-start">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Age:</span>
              <span class="fw-bold">{{ patient.age }} years</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Gender:</span>
              <span class="fw-bold text-capitalize">{{ patient.gender }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Occupation:</span>
              <span class="fw-bold">{{ patient.ocupation || 'Not specified' }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted">Resident Status:</span>
              <span class="fw-bold">{{ patient.rstatus || 'Not specified' }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-0">
              <span class="text-muted">Full Name:</span>
              <span class="fw-bold">{{ patient.abb }} {{ patient.abbname }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 2: Contact Info -->
    <div class="col-lg-4 col-md-6">
      <div class="card shadow-lg h-100 border-0">
        <div class="card-header bg-info text-white py-3">
          <h5 class="mb-0 fw-bold">
            <i class="fa fa-phone me-2"></i>Contact Information
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="d-flex align-items-center mb-3">
            <i class="fa fa-phone text-primary me-3" style="width: 20px;"></i>
            <div>
              <small class="text-muted d-block">Phone</small>
              <span class="fw-bold">{{ patient.phone || 'Not provided' }}</span>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3">
            <i class="fa fa-envelope text-primary me-3" style="width: 20px;"></i>
            <div>
              <small class="text-muted d-block">Email</small>
              <span class="fw-bold">{{ patient.email || 'Not provided' }}</span>
            </div>
          </div>
          <div class="d-flex align-items-center mb-3">
            <i class="fa fa-calendar text-primary me-3" style="width: 20px;"></i>
            <div>
              <small class="text-muted d-block">Date of Birth</small>
              <span class="fw-bold">{{ patient.dob | date:'mediumDate' }}</span>
            </div>
          </div>
          <div class="d-flex align-items-center mb-0">
            <i class="fa fa-id-card text-primary me-3" style="width: 20px;"></i>
            <div>
              <small class="text-muted d-block">ID Number</small>
              <span class="fw-bold">{{ patient.idnum || 'Not provided' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 3: Address Info -->
    <div class="col-lg-4 col-md-6">
      <div class="card shadow-lg h-100 border-0">
        <div class="card-header bg-success text-white py-3">
          <h5 class="mb-0 fw-bold">
            <i class="fa fa-map-marker me-2"></i>Address Information
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="mb-3">
            <small class="text-muted d-block mb-1">Residential Address</small>
            <div class="p-3 bg-light rounded">
              <i class="fa fa-home text-success me-2"></i>
              <span class="fw-bold">{{ patient.raddress }}, {{ patient.rcity }}, {{ patient.rstate }} - {{ patient.rzipcode }}</span>
            </div>
          </div>
          <div class="mb-3">
            <small class="text-muted d-block mb-1">Permanent Address</small>
            <div class="p-3 bg-light rounded">
              <i class="fa fa-building text-success me-2"></i>
              <span class="fw-bold">{{ patient.paddress }}, {{ patient.pcity }}, {{ patient.pstate }} - {{ patient.pzipcode }}</span>
            </div>
          </div>
          <div class="mb-0">
            <small class="text-muted d-block mb-1">ID Proof</small>
            <span class="badge bg-primary">{{ patient.addressTextProof || 'Not provided' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 4: Caretakers -->
    <div class="col-lg-6 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">Caretakers</h5>
        </div>
        <div class="card-body">
          <div *ngIf="caretakersList.length > 0; else noCaretaker">
            <div *ngFor="let c of caretakersList">
              <p>{{ c.name }} ({{ c.relation }})</p>
              <p class="small">{{ c.phone }} | {{ c.email }}</p>
              <p class="small">{{ c.address }}</p>
              <hr *ngIf="caretakersList.length > 1">
            </div>
          </div>
          <ng-template #noCaretaker>
            <p class="text-muted text-center">No caretakers added</p>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Card 5: Habits -->
    <div class="col-lg-6 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">Habits</h5>
        </div>
        <div class="card-body">
          <div *ngFor="let h of habitsArray">
            <p>
              <strong>{{ h.name }}:</strong> {{ h.value | titlecase }}
              <span *ngIf="h.value==='yes' && h.years">({{ h.years }} years)</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Card 6: Questions -->
    <div class="col-lg-6 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Health Questions</h5>
        </div>
        <div class="card-body">
          <div *ngFor="let q of questionsArray; let i = index">
            <p><strong>{{ q.text }}:</strong> </p>
            <p class="small" ><strong>Answer:</strong> {{ q.answer | titlecase }}</p>
            <p class="small" *ngIf="q.details"><strong>Details:</strong> {{ q.details }}</p>
            <hr *ngIf="i < questionsArray.length - 1">
          </div>
          
          <div *ngIf="questionsArray.length === 0" class="text-muted text-center">
            No questions answered
          </div>
          
        </div>
      </div>
    </div>

    <!-- Card 7: Insurance -->
    <div class="col-lg-6 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Insurance Details</h5>
        </div>
        <div class="card-body">
          <p><strong>Company:</strong> {{ patient.insurance?.insuranceCompany || 'N/A' }}</p>
          <p><strong>Sum Insured:</strong> {{ patient.insurance?.sumInsured || 'N/A' }}</p>
          <p><strong>Package:</strong> {{ patient.insurance?.package || 'N/A' }} - {{ patient.insurance?.packageDetail || 'N/A' }}</p>
          <p><strong>Declined Coverage:</strong> {{ patient.insurance?.declinedCoverage || 'N/A' }}</p>
          <p><strong>Similar Insurances:</strong> {{ patient.insurance?.similarInsurances || 'N/A' }}</p>
          <p><strong>Hospitals:</strong></p>
          <ul>
            <li *ngFor="let h of patient.insurance?.hospitals">{{ h.hospitalName }} - {{ h.hospitalAddress }}</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Card 8: Files -->
    <div class="col-lg-6 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fa fa-file-alt me-2"></i>Proof Files
            <span class="badge bg-light text-dark ms-2">{{ proofFileArray.length }}</span>
          </h5>
        </div>
        <div class="card-body">
          <div *ngIf="proofFileArray.length > 0; else noProofFiles">
            <div *ngFor="let file of proofFileArray; let i = index" class="mb-2">
              <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                <div class="d-flex align-items-center">
                  <i class="fa fa-file-alt text-primary me-2"></i>
                  <span class="small">{{ file.split('/').pop() }}</span>
                </div>
                <div>
                  <button class="btn btn-sm btn-info me-1" (click)="viewFile(file)">
                    <i class="fa fa-eye"></i>
                  </button>
                  <!-- <button class="btn btn-sm btn-success" (click)="downloadFile(file)">
                    <i class="fa fa-download"></i>
                  </button> -->
                </div>
              </div>
            </div>
          </div>
          <ng-template #noProofFiles>
            <p class="text-muted text-center">No proof files uploaded</p>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Card 9: Policy Files -->
    <div class="col-lg-6 col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="fa fa-file-contract me-2"></i>Policy Files
            <span class="badge bg-light text-dark ms-2">{{ policyFilesArray.length }}</span>
          </h5>
        </div>
        <div class="card-body">
          <div *ngIf="policyFilesArray.length > 0; else noPolicyFiles">
            <div *ngFor="let file of policyFilesArray; let i = index" class="mb-2">
              <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                <div class="d-flex align-items-center">
                  <i class="fa fa-file-contract text-warning me-2"></i>
                  <span class="small">{{ file.split('/').pop() }}</span>
                </div>
                <div>
                  <button class="btn btn-sm btn-info me-1" (click)="viewFile(file)">
                    <i class="fa fa-eye"></i>
                  </button>
                  <!-- <button class="btn btn-sm btn-success" (click)="downloadFile(file)">
                    <i class="fa fa-download"></i>
                  </button> -->
                </div>
              </div>
            </div>
          </div>
          <ng-template #noPolicyFiles>
            <p class="text-muted text-center">No policy files uploaded</p>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Card 10: Selected Diseases -->
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">Selected Diseases</h5>
        </div>
        <div class="card-body">
          <div *ngIf="patient.selectedDiseases?.length > 0; else noDiseases">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Category</th>
                  <th>Disease</th>
                  <th>System</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of patient.selectedDiseases">
                  <td>{{ d.code }}</td>
                  <td>{{ d.category_name }}</td>
                  <td>{{ d.disease_name }}</td>
                  <td>{{ d.system_name }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noDiseases>
            <p class="text-muted text-center">No diseases selected</p>
          </ng-template>
        </div>
      </div>
    </div>

  </div>
</div>
